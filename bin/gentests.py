#!/usr/bin/env python

# This generates the empty shells for testing each sendable command.
# When adding commands, do not check in the generated file - just copy/paste
# the generated test into tests/irc/test_serialize_rfc2812.py and fill
# out the permutation matrix.

# if the command has a new param name, add it to GLOBAL_ARGS below.
import typing as t
import re
import os
from pathlib import Path
from bottom.irc import KNOWN_COMMANDS, Command

HEADER = """
# ============================================================================
# DO NOT CHECK THIS FILE IN.
# This generates the shell of a test class for every known command.
# From here, you should copy the test class into tests/irc/test_serialize_rfc2812.py
#   and then fill out the various fields to exercise permutations of the arguments.
# You should:
#   1. update any values in `arguments_map` to test specific inputs
#   2. add param lists to `permutations`
#   3. add to `expected_map` any names for expected strings.  these are used to check the outcome of each permutation.
#   4. update `base_permutations()` to the correct default indexes.  for example, if "nick", "target", and "nick-list"
#      are in the arguments_map, you probably only want the permutation of indexes [0,1] not [0,1,2]
# generated by bin/gentests.py
# ============================================================================

from tests.helpers.base_classes import BaseSerializeTest
from tests.helpers.fns import base_permutations

""".strip()


TEMPLATE = """
class Test_{command.bottom}(BaseSerializeTest):
    # {command.syntax}
    # patterns:
    # {patterns}
    # examples:
    # {examples}
    command = "{command.bottom}"
    argument_map = [
        {argument_map_list}
    ]
    expected_map = {{
        "ERR": ValueError,
    }}
    permutations = base_permutations({permutation_index_list}, "ERR")
    permutations.update(
        {{
            (0,): "TODO",
        }}
    )
"""

GLOBAL_ARGS: dict[str, tuple[str, t.Any]] = {
    "channel": ("channel", "#chan"),
    "channel:comma": ("channel-list", ["#one", "#two"]),
    "count": ("count", 3),
    "distribution": ("distribution", "*.fr"),
    "info": ("info", "my-info"),
    "key:comma": ("key-list", ["key1", "key2"]),
    "mask": ("mask", "TODO"),
    "mask:comma": ("mask-list", "TODO"),
    "message": ("message", "msg msg"),
    "message:nospace": ("message-nospace", "msg.msg"),
    "mode": ("mode", "+i"),
    "modes": ("modes", "-io"),
    "nick": ("nick", "n0"),
    "nick:comma": ("nick-list", ["n0", "n1"]),
    "nick:space": ("nick-list", ["n0", "n1"]),
    "o:bool": ("o:bool", True),
    "params:space": ("params-list", ["+imI", "*!*@*.fi"]),
    "password": ("password", "hunter2"),
    "port": ("port", 1024),
    "query": ("query", "m"),
    "realname": ("realname", "my.realname"),
    "remote": ("remote", "*.edu"),
    "server": ("server", "tolsun.oulu.fi"),
    "target": ("target", "TODO"),
    "type": ("type", 3),
}
ARG_RE = re.compile(r"\{(.*?)\}")


def gather_args(command: Command) -> list[str]:
    args = []
    for pattern in command.patterns:
        for arg in ARG_RE.findall(pattern):
            if arg not in args:
                args.append(arg)
    return args


def lookup_arg(arg: str) -> str:
    try:
        raw = GLOBAL_ARGS[arg]
    except KeyError:
        print(f"unknown param key {arg} -- is it missing from GLOBAL_ARGS?")
        raise
    return f"{raw!r},"


def render_test_class(command: Command) -> str:
    arguments = [lookup_arg(arg) for arg in gather_args(command)]
    return TEMPLATE.format(
        command=command,
        argument_map_list="\n        ".join(arguments),
        patterns="\n    # ".join(command.patterns),
        examples="\n    # ".join(command.examples),
        permutation_index_list=repr(list(range(len(arguments)))),
    )


def main(dst: Path) -> None:
    out = [HEADER]
    for command in KNOWN_COMMANDS:
        out.append(render_test_class(command).strip())
    all = "\n\n\n".join(out) + "\n"
    dst.parent.mkdir(exist_ok=True)
    dst.write_text(all)


if __name__ == "__main__":
    root = (Path(os.path.dirname(__file__)) / "..").resolve()
    dst = root / "build/generated.py"
    main(dst)
